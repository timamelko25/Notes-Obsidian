
Набор требований к транзакционной системе **ACID** (atomicity (атомарность), consistency (согласованность), isolation (изоляция), durability (устойчивость))

- **Atomicity** (атомарность)
Атомарность гарантирует что каждая транзакция будет выполнена полностью или не выполнена совсем без промежуточных операций

- **Consistency** (согласованность)
Транзакция не допускает промежуточных результатов, тем самым остается согласованной

- **Isolation** (изоляция)
Определяет как транзакции могут взаимодействовать между собой, насколько сильно могут пересекаться и мешать параллельной работе. Разные уровни изоляции допускают или не допускают разные аномалии при параллельной работе транзакций

- **Durability** (устойчивость)
Сохранность выполненной операции, при любом исходе. 

## Isolation

4 основные уровня изоляции:
- **READ UNCOMMITTED**
Самый слабый уровень изоляции. Транзакция может видеть результаты других транзакций, даже если они не закоммичены

**Проблемы**:
1. **Dirty read** (грязное чтение)
2. **Non-repeaeable read** / **Fuzz read**
3. **Phantom read** (фантомное чтение) 
4. **Lost update**
5. **Out-of-order read** (неупорядоченное чтение) 

- **READ COMMITTED**
Транзакция может читать только те изменения в других параллельных транзакциях которые уже были закоммичены

**Проблемы**:
- **Dirty read** решается
- **Fuzz read** остается
- **Phantom read** остается
- **Lost update** остается
- **Out-of-order read** остается

- **REPEATABLE READ**
Пока транзакция не завершится никто параллельно не может изменять или удалять строки, которые транзакция уже прочитала

**Проблемы**:
- **Dirty read** решается
- **Fuzz read** решается
- **Phantom read** остается

- **SERIALIZABLE**
самый жесткий, тяжелый, медленный для обработки запросов. Блокировка любых действий при запущенной транзакции

**Проблемы**: 
- Все решается 

![[Pasted image 20250204231442.png]]

*Редкие методы изоляции*:
- **READ STABILITY** - данные прочитанные первой транзакцией не будут изменены другой транзакцией до завершения первой транзакции. нет проблемы неповторяющегося чтения но есть фантомные чтения
- **CURSOR STABILITY** - блокирует строку прочитанную через курсор
- **SNAPSHOT ISOLATION**  многоверсионная изоляция - (SQL SERVER) - делается снимок бд на момент начала транзакции, нет проблемы фантомного чтения и неповторяющегося чтения, не блокируются данные при чтении, обеспечивается параллелизм. нет полной сериализации, остается Lost update. Работает через MVCC
- **SERIALIZABLE SNAPSHOT ISOLATION SSI** (PosrgeSQL) - улучшает SERIALIZABLE. использует MVCC

! Уровни изоляции по умолчанию в postgreSQL READ COMMITTED, SQlite SERIALIZED

**Проблемы**:
1. **Dirty read** (грязное чтение) - данные при чтении, можно откатить до завершения транзакции

- Селект баланса
- Изменение баланса без коммита
- Селект вернет новый баланс
- Откат баланса
- Селект вернет измененный (неверный) баланс

2. **Non-repeaeable read** / **Fuzz read** - прочитанные данные несколько раз возвращают разные результаты из-за коммитов другой транзакции
3. **Phantom read** (фантомное чтение) - прочитанные данные несколько раз возвращают разное количество строк из-за добавления и удаления другой транзакцией
4. **Lost update** - две транзакции изменяют одну строку без учета изменений друг друга, одна модификация теряется
5. **Out-of-order read** (неупорядоченное чтение) - несколько чтений в произвольном порядке могут привести к неправильному результату в транзакциях

**MVCC** (Multiversion Concurrency Control) - метод управления конкурентным доступом к данным в БД который позволяет нескольким транзакциям работать с данными одновременно без конфликтов. Поддерживает высокую производительность, изоляцию транзакций, минимизация блокировок, улучшенный параллелизм.
Работает в каждой СУБД с разной реализацией
Используемые технологии:
- многоверсионность - создается новая версия данных вместо изменения строки в бд и она меняется
- изоляция - транзакция видит только те данные которые были зафиксированы до ее начала. предотвращает грязное чтение, неповторяющееся чтение и фантомное чтение
- отсутствие блокировок для чтения и записи. повышает производительность
- управление конфликтами