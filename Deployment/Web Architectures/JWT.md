- [Основные понятия](#%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5%20%D0%BF%D0%BE%D0%BD%D1%8F%D1%82%D0%B8%D1%8F)
- [Преимущества JWT](#%D0%9F%D1%80%D0%B5%D0%B8%D0%BC%D1%83%D1%89%D0%B5%D1%81%D1%82%D0%B2%D0%B0%20JWT)
- [Структура JWT](#%D0%A1%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0%20JWT)
- [Типы JWT](#%D0%A2%D0%B8%D0%BF%D1%8B%20JWT)
- [Передача токенов](#%D0%9F%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B0%20%D1%82%D0%BE%D0%BA%D0%B5%D0%BD%D0%BE%D0%B2)
- [Валидация токена](#%D0%92%D0%B0%D0%BB%D0%B8%D0%B4%D0%B0%D1%86%D0%B8%D1%8F%20%D1%82%D0%BE%D0%BA%D0%B5%D0%BD%D0%B0)
- [Управление временем жизни (TTL)](#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%B5%D0%BC%20%D0%B6%D0%B8%D0%B7%D0%BD%D0%B8%20(TTL))
- [Отзыв токенов](#%D0%9E%D1%82%D0%B7%D1%8B%D0%B2%20%D1%82%D0%BE%D0%BA%D0%B5%D0%BD%D0%BE%D0%B2)
- [Лучшие практики использования JWT](#%D0%9B%D1%83%D1%87%D1%88%D0%B8%D0%B5%20%D0%BF%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B8%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20JWT)
- [Преимущества JWT](#%D0%9F%D1%80%D0%B5%D0%B8%D0%BC%D1%83%D1%89%D0%B5%D1%81%D1%82%D0%B2%D0%B0%20JWT)
- [Ограничения JWT](#%D0%9E%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D1%8F%20JWT)
- [Использование JWT](#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20JWT)


JSON Web Token - ключ аутентификации пользователя. Используется для запросов к защищенным методам API.

Идентификация - процесс получения идентификатора пользователя: логин пароль
Аутентификация - подтверждение корректности введенных данных: логин и пароль подходят
Авторизация - проверка пользователя на наличие прав на выполняемое действие
Валидация - проверка данных на корректность

Преимущества JWT перед учетными данными пользователя:
- не нужно передавать учетные данные пользователя с каждым запросом к серверу
- ограниченный TTL защищает от длительного подбора данных
- нет постоянного обращения к бд, ускоряет работу

TTL токена: время жизни токена закодирована в тело, при валидации сервер извлекает данные из токена и проверяет, что токен не истек

Для отзыва токенов раньше времени их необходимо хранить in-memory-cache или Redis

Для передачи токенов
- от сервера к клиенту
	- в теле запроса 
	- заголовок `Set-Cookie`: `Set-Cookie: accessToken=<jwt>; HttpOnly; Sequre; SameSite=Strict;
- от клиента к серверу
	- в заголовке к серверу с заголовков `Authorization`: `Authorization: Bearer <jwt>`
	- заголовок `Cookie`: `Cookie: accessToken=<jwt>`

Виды JWT
- `access token` - проверяется при каждом обращении к защищенному API
	- многоразовый
	- в каждом запросе в заголовке `authorization`
	- короткий срок жизни (минуты)
	- после истечения срока жизни 401 статус
- `refresh token` - токен для получения новой пары токенов (access и refresh)
	- одноразовый
	- длительный срок жизни (дни)
	- редирект на переавторизацию после истечения access token
- `bearer token` - частный случай access токена. 

Структура JWT
- header - содержит информацию об алгоритме шифрования и типе токена (JWT)
- payload - данные токена
	- iss (Issuer) — издатель токена. Как правило — uuid приложения, выпустившего токен.
	- sub (Subject) — собственник токена. Как правило — uuid пользователя
	- aud (Audience) — массив url серверов, для которых предназначен токен
	- exp (Expiration Time) — время, в течение которого токен считается валидным.
	- nbf (Not Before) — временная метка, до которй токен не считается валидным
	- iat (Issued At) — время создания токена
	- jti (JWT ID) — уникальный идентификатор токена
- signature - криптографическая подпись

Валидация токена



JSON Web Token (JWT) — это компактный и самодостаточный стандарт для передачи данных между сторонами в виде JSON-объекта. JWT широко используется для аутентификации и авторизации пользователей при обращении к защищенным методам API. Токен содержит зашифрованные данные, которые позволяют серверу проверить подлинность запроса без необходимости повторной передачи учетных данных пользователя.

JWT обеспечивает безопасный и эффективный способ аутентификации, минимизируя обращения к базе данных и упрощая управление сеансами. Он особенно популярен в современных веб-приложениях и микросервисных архитектурах.

## Основные понятия

Для понимания работы JWT важно различать следующие процессы:

- **Идентификация**: Определение идентификатора пользователя, например, через ввод логина и пароля.
    
- **Аутентификация**: Проверка корректности предоставленных данных (например, соответствие логина и пароля).
    
- **Авторизация**: Проверка прав пользователя на выполнение конкретного действия или доступ к ресурсу.
    
- **Валидация**: Проверка корректности данных, включая формат и целостность токена.
    

## Преимущества JWT

По сравнению с традиционной передачей учетных данных пользователя (логин и пароль), JWT имеет следующие преимущества:

- **Отсутствие необходимости передачи учетных данных**: После аутентификации клиент получает токен, который используется для последующих запросов, исключая необходимость повторной отправки логина и пароля.
    
- **Ограниченный срок действия (TTL)**: Время жизни токена задается при его создании, что защищает от длительного использования скомпрометированного токена.
    
- **Уменьшение нагрузки на базу данных**: Данные, необходимые для проверки токена, содержатся в самом токене, что устраняет необходимость частых обращений к базе данных.
    
- **Кроссплатформенность**: JWT поддерживается большинством языков программирования и платформ.
    

## Структура JWT

JWT состоит из трех основных частей, разделенных точками (.): **Header**, **Payload** и **Signature**. Каждая часть кодируется в формате Base64Url и вместе образует строку вида: header.payload.signature.

1. **Header**  
    Содержит метаданные о токене, включая:
    
    - Тип токена (typ: "JWT").
        
    - Алгоритм шифрования (alg), например, HS256 (HMAC-SHA256) или RS256 (RSA-SHA256).
        
    
    Пример:
    
    ```json
    {
      "alg": "HS256",
      "typ": "JWT"
    }
    ```
    
2. **Payload**  
    Содержит данные, которые передаются в токене (так называемые _claims_). Claims делятся на три категории:
    
    - **Зарегистрированные claims** (рекомендуемые):
        
        - iss (Issuer) — идентификатор издателя токена (например, UUID приложения).
            
        - sub (Subject) — идентификатор субъекта токена (например, UUID пользователя).
            
        - aud (Audience) — массив URL серверов, для которых предназначен токен.
            
        - exp (Expiration Time) — временная метка, после которой токен становится недействительным.
            
        - nbf (Not Before) — временная метка, до которой токен не считается валидным.
            
        - iat (Issued At) — время создания токена.
            
        - jti (JWT ID) — уникальный идентификатор токена.
            
    - **Публичные claims**: Пользовательские данные, определенные стандартами (например, email).
        
    - **Приватные claims**: Пользовательские данные, специфичные для приложения.
        
    
    Пример:
    
    ```json
    {
      "sub": "user123",
      "iss": "auth.example.com",
      "exp": 1697059200,
      "iat": 1697055600,
      "role": "admin"
    }
    ```
    
3. **Signature**  
    Криптографическая подпись, которая создается путем объединения закодированных Base64Url Header и Payload, подписанных с использованием секретного ключа и указанного алгоритма. Подпись гарантирует, что токен не был изменен.
    
    Формула:
    
    ```
    Signature = HMACSHA256(base64UrlEncode(header) + "." + base64UrlEncode(payload), secret)
    ```
    

## Типы JWT

JWT используется в различных сценариях, и в зависимости от назначения выделяют несколько типов токенов:

1. **Access Token**
    
    - Используется для доступа к защищенным ресурсам API.
        
    - Передается в каждом запросе в заголовке Authorization: Bearer <token>.
        
    - Имеет короткий срок жизни (обычно минуты, например, 15–60 минут).
        
    - Многоразовый в течение срока действия.
        
    - При истечении срока возвращается ошибка 401 Unauthorized.
        
2. **Refresh Token**
    
    - Используется для получения новой пары токенов (access и refresh) после истечения срока действия access token.
        
    - Имеет длительный срок жизни (дни или недели).
        
    - Обычно одноразовый: после использования старый refresh token становится недействительным.
        
    - Хранится в безопасном месте на стороне клиента (например, в HttpOnly cookie).
        
    - При истечении срока действия refresh token пользователь перенаправляется на страницу повторной аутентификации.
        
3. **Bearer Token**
    
    - Частный случай access token, передаваемый в заголовке Authorization: Bearer <token>.
        
    - Используется для аутентификации запросов к API.
        

## Передача токенов

Передача JWT между клиентом и сервером осуществляется следующими способами:

- **От сервера к клиенту**:
    
    - В теле ответа (например, в формате JSON):
        
        ```json
        {
          "accessToken": "<jwt>",
          "refreshToken": "<jwt>"
        }
        ```
        
    - В заголовке Set-Cookie (для безопасного хранения):
        
        ```
        Set-Cookie: accessToken=<jwt>; HttpOnly; Secure; SameSite=Strict
        ```
        
- **От клиента к серверу**:
    
    - В заголовке Authorization:
        
        ```
        Authorization: Bearer <jwt>
        ```
        
    - В заголовке Cookie (если токен был установлен через Set-Cookie):
        
        ```
        Cookie: accessToken=<jwt>
        ```
        

## Валидация токена

Процесс валидации JWT включает следующие шаги:

1. **Проверка подписи**: Сервер проверяет целостность токена, используя секретный ключ или публичный ключ (в зависимости от алгоритма).
    
2. **Проверка claims**:
    
    - Убедиться, что токен не истек (exp).
        
    - Проверить, что токен действителен после времени nbf.
        
    - Убедиться, что токен предназначен для данного сервера (aud).
        
3. **Проверка издателя и субъекта**: Удостовериться, что iss и sub соответствуют ожидаемым значениям.
    
4. **Проверка уникальности** (если используется jti): Убедиться, что токен не был использован ранее.
    

Если валидация не пройдена, сервер возвращает ошибку (например, 401 Unauthorized или 403 Forbidden).

![[Pasted image 20250518140728.png]]

## Управление временем жизни (TTL)

- **Время жизни токена (TTL)**: Закодировано в поле exp в payload. Сервер извлекает это значение и проверяет, не истек ли токен.
    
- **Короткий TTL для access token**: Обеспечивает безопасность, так как скомпрометированный токен быстро становится недействительным.
    
- **Длинный TTL для refresh token**: Позволяет пользователю оставаться аутентифицированным в течение длительного времени без повторного ввода учетных данных.
    

## Отзыв токенов

Для отзыва токенов до истечения их срока действия (например, при подозрении на компрометацию) используются следующие подходы:

- **Хранение токенов в in-memory cache** (например, Redis): Сервер ведет список действительных или отозванных токенов.
    
- **Черный список**: Токены, которые нужно отозвать, добавляются в список недействительных токенов.
    
- **Одноразовые refresh token**: После использования refresh token он становится недействительным, что снижает риск повторного использования.
    

## Лучшие практики использования JWT

- **Используйте HTTPS**: Все запросы с JWT должны передаваться через защищенное соединение, чтобы предотвратить перехват токена.
    
- **Храните токены безопасно**: Используйте HttpOnly, Secure и SameSite=Strict для cookie, чтобы защитить токены от XSS и CSRF атак.
    
- **Ограничивайте TTL**: Устанавливайте минимально необходимое время жизни для access token.
    
- **Используйте надежные алгоритмы**: Предпочтительно HS256 или RS256 для подписи токена. Избегайте использования none как алгоритма.
    
- **Валидируйте все claims**: Проверяйте iss, aud, exp, nbf и другие поля для обеспечения безопасности.
    
- **Минимизируйте данные в payload**: Включайте только необходимые данные, чтобы уменьшить размер токена и снизить риск утечки информации.
    
- **Поддерживайте версионирование**: Если структура токена меняется, используйте версионирование для обратной совместимости.
    

## Преимущества JWT

- **Самодостаточность**: Вся необходимая информация содержится в токене, что устраняет необходимость обращения к базе данных.
    
- **Масштабируемость**: Подходит для распределенных систем и микросервисов.
    
- **Кроссплатформенность**: Поддерживается большинством языков и фреймворков.
    
- **Гибкость**: Может использоваться для аутентификации, авторизации и передачи данных.
    

## Ограничения JWT

- **Размер токена**: JWT может быть больше, чем традиционные сессионные идентификаторы, особенно при включении большого количества данных в payload.
    
- **Сложность отзыва**: Без дополнительной инфраструктуры (например, Redis) отозвать токен до истечения его срока действия сложно.
    
- **Уязвимости**: Неправильная реализация (например, слабый секретный ключ или отсутствие проверки подписи) может привести к уязвимостям.
    
- **Ограниченная поддержка в браузерах**: Некоторые браузеры могут ограничивать работу с cookie или заголовками, что усложняет передачу токенов.
    

## Использование JWT

JWT применяется в следующих сценариях:

- **Аутентификация в API**: Для доступа к защищенным ресурсам REST или gRPC API.
    
- **Микросервисы**: Для передачи аутентификационной информации между сервисами.
    
- **Одностраничные приложения (SPA)**: Для управления сеансами в веб-приложениях.
    
- **Мобильные приложения**: Для безопасного обмена данными между клиентом и сервером.